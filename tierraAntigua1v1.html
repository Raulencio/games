<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tierra Antigua 1v1</title>

    <link rel="icon" href="tt.png" type="image/png">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #333;
        }

        /* Canvas oculto hasta iniciar juego */
        #gameCanvas {
            display: none;
            background: linear-gradient(#34495e, #2c3e50);
        }

        /* Men√∫ de inicio visible por defecto */
        #menuInicio {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 2;
        }

        /* Pantalla de selecci√≥n oculta hasta hacer click en ‚Äújugar‚Äù */
        #pantallaSeleccion {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* ¬°mantiene oculta! */
            z-index: 2;
            flex-direction: row;
            justify-content: space-around;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        .jugadorSeleccion {
            width: 45%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cartasDisponibles,
        .cartasElegidas {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
        }

        .carta {
            width: 64px;
            height: 64px;
            margin: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            border: none;
            transition: border 0.3s ease;
        }

        .carta img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carta.seleccionada {
            background: rgba(39, 174, 96, 0.5) !important;
            /* destaca la carta */
        }


        .jugadorSeleccion button {
            margin-top: 10px;
            padding: 5px 15px;
            font-size: 1em;
            background: #2980b9;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        .jugadorSeleccion button:hover {
            background: #3498db;
        }

        /* Paneles de cartas en batalla */
        .panelCartas {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 3;
        }

        #panel1 {
            left: 10px;
        }

        #panel2 {
            right: 10px;
        }

        /* Barras de energ√≠a */
        .barraEnergia {
            position: absolute;
            width: 40%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .energia {
            height: 100%;
            width: 0%;
            background: #27ae60;
            transition: width 0.2s;
            position: relative;
            z-index: 2;
        }

        .previewEnergia {
            height: 100%;
            width: 0%;
            background: rgba(255, 255, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
            pointer-events: none;
            transition: width 0.2s;
        }

        #barraEnergia1 {
            top: 10px;
            left: 5%;
        }

        #barraEnergia2 {
            top: 10px;
            right: 5%;
            transform: scaleX(-1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #pantallaSeleccion {
                flex-direction: column;
                padding: 10px;
                align-items: center;
            }

            .jugadorSeleccion {
                width: 90%;
                margin-bottom: 20px;
            }

            .carta {
                width: 20vw !important;
                aspect-ratio: 1/1;
            }

            .jugadorSeleccion button {
                width: 80%;
                font-size: 1.2em;
                padding: 12px 0;
            }
        }

        /* Ajustes para las cartas en los paneles de batalla */
        .panelCartas {
            /* M√°ximo alto para no salirse de pantalla y permitir scroll */
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Carta dentro del panel: tama√±o fijo en PC, proporcional en m√≥vil */
        .panelCartas .carta canvas {
            width: auto !important;
            height: 100% !important;
            display: block;
        }


        @media (max-width: 768px) {
            .panelCartas .carta {
                /* 12% del ancho de la pantalla */
                width: 12vw !important;
                height: auto;
            }
        }

        .pantallaGameOver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
            z-index: 9999;
        }

        button.listo {
            background-color: #4CAF50;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 10px #00ff00;
        }
    </style>

</head>

<body>

    <!-- Men√∫ inicio -->
    <div id="menuInicio">
        <h1>üåå Tierra Antigua 1v1 üåå</h1>
        <button onclick="iniciarSeleccion()">‚öîÔ∏è Click para jugar ‚öîÔ∏è</button>
    </div>

    <!-- Pantalla selecci√≥n -->
    <div id="pantallaSeleccion">
        <div class="jugadorSeleccion" id="jugador1">
            <h2>Jugador 1</h2>
            <div class="cartasDisponibles" id="cartasDisponibles1"></div>
            <h3>Elegidas:</h3>
            <div class="cartasElegidas" id="cartasElegidas1"></div>
            <button id="btnListo1" onclick="jugadorListo(1)">Listo</button>
        </div>
        <div class="jugadorSeleccion" id="jugador2">
            <h2>Jugador 2</h2>
            <div class="cartasDisponibles" id="cartasDisponibles2"></div>
            <h3>Elegidas:</h3>
            <div class="cartasElegidas" id="cartasElegidas2"></div>
            <button id="btnListo2" onclick="jugadorListo(2)">Listo</button>
        </div>
    </div>

    <!-- Canvas de batalla -->
    <canvas id="gameCanvas"></canvas>

    <!-- Paneles de cartas en batalla -->
    <div id="panel1" class="panelCartas"></div>
    <div id="panel2" class="panelCartas"></div>

    <!-- Barras de energ√≠a -->
    <div id="barraEnergia1" class="barraEnergia">
        <div id="energia1" class="energia"></div>
        <div id="previewEnergia1" class="previewEnergia"></div>
    </div>
    <div id="barraEnergia2" class="barraEnergia">
        <div id="energia2" class="energia"></div>
        <div id="previewEnergia2" class="previewEnergia"></div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        const personajes = [
            {
                nombre: "Samurai",
                idleSrc: "Samurai/Idle.png",
                walkSrc: "Samurai/Walk.png",
                runSrc: "Samurai/Run.png",
                attack1Src: "Samurai/Attack_1.png",
                attack2Src: "Samurai/Attack_2.png",
                deathSrc: "Samurai/Dead.png",
                deathFrames: 6,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 5,
                walkFrames: 9,
                runFrames: 8,
                attack1Frames: 4,
                attack2Frames: 5,
                peso: 25,
                hpMax: 150,
                damage: 35,
                regenRate: 4,
                ataqueDistancia: false,
                costo: 2,
                speed: 2,
            },
            {
                nombre: "Commandante",
                idleSrc: "Samurai_Commander/Idle.png",
                walkSrc: "Samurai_Commander/Walk.png",
                runSrc: "Samurai_Commander/Run.png",
                attack1Src: "Samurai_Commander/Attack_1.png",
                attack2Src: "Samurai_Commander/Attack_2.png",
                deathSrc: "Samurai_Commander/Dead.png",
                deathFrames: 6,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 5,
                walkFrames: 9,
                runFrames: 8,
                attack1Frames: 4,
                attack2Frames: 5,
                peso: 35,
                hpMax: 180,
                damage: 30,
                regenRate: 3,
                ataqueDistancia: false,
                costo: 2,
                speed: 2,
            },
            {
                nombre: "Kunoichi",
                idleSrc: "Kunoichi/Idle.png",
                walkSrc: "Kunoichi/Walk.png",
                runSrc: "Kunoichi/Run.png",
                attack1Src: "Kunoichi/Attack_1.png",
                attack2Src: "Kunoichi/Attack_2.png",
                deathSrc: "Kunoichi/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 9,
                walkFrames: 8,
                runFrames: 8,
                attack1Frames: 6,
                attack2Frames: 8,
                peso: 20,
                hpMax: 110,
                damage: 45,
                regenRate: 3,
                ataqueDistancia: false,
                costo: 1,
                speed: 3,
            },
            {
                nombre: "Mago Errante",
                idleSrc: "Wanderer Magican/Idle.png",
                walkSrc: "Wanderer Magican/Walk.png",
                runSrc: "Wanderer Magican/Run.png",
                attack1Src: "Wanderer Magican/Attack_1.png",
                attack2Src: "Wanderer Magican/Attack_2.png",
                deathSrc: "Wanderer Magican/Dead.png",
                deathFrames: 4,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 8,
                walkFrames: 7,
                runFrames: 8,
                attack1Frames: 7,
                attack2Frames: 9,
                peso: 20,
                hpMax: 90,
                damage: 40,
                regenRate: 6,
                ataqueDistancia: false,
                costo: 2,
                speed: 1.8,
            },
            {
                nombre: "Maga El√©ctrica",
                idleSrc: "Lightning Mage/Idle.png",
                walkSrc: "Lightning Mage/Walk.png",
                runSrc: "Lightning Mage/Run.png",
                attack1Src: "Lightning Mage/Attack_1.png",
                attack2Src: "Lightning Mage/Attack_2.png",
                deathSrc: "Lightning Mage/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 7,
                walkFrames: 7,
                runFrames: 8,
                attack1Frames: 10,
                attack2Frames: 4,
                peso: 20,
                hpMax: 100,
                damage: 55,
                regenRate: 2,
                ataqueDistancia: false,
                costo: 2,
                speed: 4,
            },
            {
                nombre: "Esqueleto Lancero",
                idleSrc: "Skeleton_Spearman/Idle.png",
                walkSrc: "Skeleton_Spearman/Walk.png",
                runSrc: "Skeleton_Spearman/Run.png",
                attack1Src: "Skeleton_Spearman/Attack_1.png",
                attack2Src: "Skeleton_Spearman/Attack_2.png",
                deathSrc: "Skeleton_Spearman/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 7,
                walkFrames: 7,
                runFrames: 8,
                attack1Frames: 4,
                attack2Frames: 4,
                peso: 20,
                hpMax: 150,
                damage: 25,
                regenRate: 4,
                ataqueDistancia: false,
                costo: 1,
                speed: 2,
            },
            {
                nombre: "Esqueleto Guerrero",
                idleSrc: "Skeleton_Warrior/Idle.png",
                walkSrc: "Skeleton_Warrior/Walk.png",
                runSrc: "Skeleton_Warrior/Run.png",
                attack1Src: "Skeleton_Warrior/Attack_1.png",
                attack2Src: "Skeleton_Warrior/Attack_2.png",
                deathSrc: "Skeleton_Warrior/Dead.png",
                deathFrames: 4,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 7,
                walkFrames: 7,
                runFrames: 8,
                attack1Frames: 5,
                attack2Frames: 6,
                peso: 30,
                hpMax: 250,
                damage: 20,
                regenRate: 5,
                ataqueDistancia: false,
                costo: 1,
                speed: 3,
            }
            ,
            {
                nombre: "Minotauro",
                idleSrc: "Minotaur_2/Idle.png",
                walkSrc: "Minotaur_2/Walk.png",
                runSrc: "Minotaur_2/Walk.png",
                attack1Src: "Minotaur_2/Attack.png",
                attack2Src: "Minotaur_2/Attack.png",
                deathSrc: "Minotaur_2/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 10,
                walkFrames: 12,
                runFrames: 8,
                attack1Frames: 5,
                attack2Frames: 5,
                peso: 30,
                hpMax: 350,
                damage: 20,
                regenRate: 5,
                ataqueDistancia: false,
                costo: 2,
                speed: 3,
            },
            {
                nombre: "Minotauro Jefe",
                idleSrc: "Minotaur_1/Idle.png",
                walkSrc: "Minotaur_1/Walk.png",
                runSrc: "Minotaur_1/Walk.png",
                attack1Src: "Minotaur_1/Attack.png",
                attack2Src: "Minotaur_1/Attack.png",
                deathSrc: "Minotaur_1/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 10,
                walkFrames: 12,
                runFrames: 8,
                attack1Frames: 5,
                attack2Frames: 5,
                peso: 30,
                hpMax: 300,
                damage: 30,
                regenRate: 5,
                ataqueDistancia: false,
                costo: 2,
                speed: 3,
            },
            {
                nombre: "Minotauro Jefa",
                idleSrc: "Minotaur_3/Idle.png",
                walkSrc: "Minotaur_3/Walk.png",
                runSrc: "Minotaur_3/Walk.png",
                attack1Src: "Minotaur_3/Attack.png",
                attack2Src: "Minotaur_3/Attack.png",
                deathSrc: "Minotaur_3/Dead.png",
                deathFrames: 5,
                frameWidth: 128,
                frameHeight: 128,
                idleFrames: 10,
                walkFrames: 12,
                runFrames: 8,
                attack1Frames: 4,
                attack2Frames: 4,
                peso: 30,
                hpMax: 400,
                damage: 24,
                regenRate: 5,
                ataqueDistancia: false,
                costo: 3,
                speed: 4,
            }
        ];

        let mazo1 = [], mazo2 = [];
        let listo1 = false, listo2 = false;

        let energia1 = 0, energia2 = 0;
        const energiaMax = 10;
        let unidades = [];
        let seleccionada1 = null, seleccionada2 = null;

        let lastTimestamp = 0;
        const energiaPorSegundo = 1; // energ√≠a que se genera por segundo


        let escalaPersonaje = 1.0;

        function actualizarEscalaPersonaje() {
            if (window.innerWidth <= 768) {
                escalaPersonaje = 0.5; // en celular son 60% del tama√±o original
            } else {
                escalaPersonaje = 1.0; // en PC tama√±o normal
            }
        }

        actualizarEscalaPersonaje();
        window.addEventListener('resize', actualizarEscalaPersonaje);



        // --- Inicio de selecci√≥n ---
        function iniciarSeleccion() {
            document.getElementById("menuInicio").style.display = "none";
            document.getElementById("pantallaSeleccion").style.display = "flex";
            cargarCartasDisponibles();

            // üëá Mostrar las cartas ya elegidas de cada jugador al entrar
            actualizarMazo(1);
            actualizarMazo(2);
        }
        function crearCartaAnimada(personaje, jugador) {
            const escala = 0.5;
            const fw = personaje.frameWidth;
            const fh = personaje.frameHeight;
            const w = fw * escala;
            const h = fh * escala;

            // 1) contenedor
            const container = document.createElement("div");
            container.className = "carta";
            container.style.width = w + "px";
            container.style.height = h + "px";
            container.style.background = "transparent";

            // 2) canvas
            const canvasCarta = document.createElement("canvas");
            canvasCarta.width = w;
            canvasCarta.height = h;
            container.appendChild(canvasCarta);
            const ctxCarta = canvasCarta.getContext("2d");

            // 3) animaci√≥n idle
            const img = new Image();
            img.src = personaje.idleSrc;
            let frame = 0;
            const total = personaje.idleFrames;
            const dur = 100;
            let last = performance.now();

            function animar() {
                if (img.complete) {
                    const now = performance.now();
                    if (now - last > dur) {
                        frame = (frame + 1) % total;
                        last = now;
                    }
                    ctxCarta.clearRect(0, 0, w, h);
                    ctxCarta.drawImage(
                        img,
                        frame * fw, 0, fw, fh,
                        0, 0, w, h
                    );
                }
                requestAnimationFrame(animar);
            }
            img.onload = animar;
            img.onerror = () => console.error("Error cargando", img.src);

            // 4) click para agregar
            container.onclick = () => {
                const mazo = jugador === 1 ? mazo1 : mazo2;
                const idx = mazo.indexOf(personaje);

                if (idx === -1 && mazo.length < 5) {
                    // no estaba en el mazo: lo a√±adimos
                    mazo.push(personaje);
                    container.classList.add("seleccionada");
                } else if (idx !== -1) {
                    // ya estaba: lo quitamos
                    mazo.splice(idx, 1);
                    container.classList.remove("seleccionada");
                }

                actualizarMazo(jugador);
            };

            return container;
        }

        function crearCartaAnimadaSinClick(personaje) {
            const escala = 0.5;
            const fw = personaje.frameWidth;
            const fh = personaje.frameHeight;
            const w = fw * escala;
            const h = fh * escala;

            const container = document.createElement("div");
            container.className = "carta";
            container.style.width = w + "px";
            container.style.height = h + "px";
            container.style.background = "transparent";

            const canvasCarta = document.createElement("canvas");
            canvasCarta.width = w;
            canvasCarta.height = h;
            container.appendChild(canvasCarta);
            const ctxCarta = canvasCarta.getContext("2d");

            const img = new Image();
            img.src = personaje.idleSrc;
            let frame = 0;
            const total = personaje.idleFrames;
            const dur = 100;
            let last = performance.now();

            function animar() {
                if (img.complete) {
                    const now = performance.now();
                    if (now - last > dur) {
                        frame = (frame + 1) % total;
                        last = now;
                    }
                    ctxCarta.clearRect(0, 0, w, h);
                    ctxCarta.drawImage(
                        img,
                        frame * fw, 0, fw, fh,
                        0, 0, w, h
                    );
                }
                requestAnimationFrame(animar);
            }
            img.onload = animar;
            img.onerror = () => console.error("Error cargando", img.src);

            return container;
        }


        // Se muestran todas las cartas disponibles para ambos jugadores
        // Cambiar la funci√≥n de carga de cartas disponibles para usar animaci√≥n idle
        function cargarCartasDisponibles() {
            const cont1 = document.getElementById("cartasDisponibles1");
            const cont2 = document.getElementById("cartasDisponibles2");
            cont1.innerHTML = "";
            cont2.innerHTML = "";

            personajes.forEach(p => {
                const carta1 = crearCartaAnimada(p, 1);
                const carta2 = crearCartaAnimada(p, 2);
                // si ya est√° en el mazo, marcamos selecci√≥n
                if (mazo1.includes(p)) carta1.classList.add("seleccionada");
                if (mazo2.includes(p)) carta2.classList.add("seleccionada");
                cont1.appendChild(carta1);
                cont2.appendChild(carta2);
            });
        }



        // Crear carta con imagen y evento para agregar al mazo (m√°ximo 8)
        function crearCartaSeleccion(personaje, jugador) {
            const div = document.createElement("div");
            div.className = "carta";
            const img = document.createElement("img");
            img.src = personaje.idleSrc;
            if (jugador === 2) img.style.transform = "scaleX(-1)"; // Voltear imagen para jugador 2
            div.appendChild(img);

            div.onclick = () => {
                if (jugador === 1) {
                    if (mazo1.length < 5) {
                        mazo1.push(personaje);
                        actualizarMazo(1);
                    }
                } else {
                    if (mazo2.length < 5) {
                        mazo2.push(personaje);
                        actualizarMazo(2);
                    }
                }
            };
            return div;
        }

        // Cambiar actualizarMazo para mostrar animaciones idle en vez de imagen est√°tica
        function actualizarMazo(jugador) {
            const cont = document.getElementById(`cartasElegidas${jugador}`);
            cont.innerHTML = "";
            const mazo = jugador === 1 ? mazo1 : mazo2;
            mazo.forEach(p => {
                const cartaAnimada = crearCartaAnimadaSinClick(p);
                // Si es jugador 2, voltea horizontalmente

                cont.appendChild(cartaAnimada);
            });
        }

        function jugadorListo(jugador) {
            const mazo = jugador === 1 ? mazo1 : mazo2;
            const btn = document.getElementById(jugador === 1 ? "btnListo1" : "btnListo2");

            // üö´ Verificamos si el jugador no ha elegido cartas
            if (mazo.length === 0) {
                alert(`Jugador ${jugador}, debes elegir al menos una carta antes de estar listo.`);
                return;
            }

            // ‚úÖ Alternamos estado "listo"
            if (jugador === 1) {
                listo1 = !listo1;
                btn.classList.toggle("listo", listo1);
                btn.innerText = listo1 ? "Cancelar" : "Listo";
            } else {
                listo2 = !listo2;
                btn.classList.toggle("listo", listo2);
                btn.innerText = listo2 ? "Cancelar" : "Listo";
            }

            // üöÄ Iniciar el juego solo si ambos est√°n listos
            if (listo1 && listo2) iniciarJuego();
        }


        // --- Inicio de juego ---
        function iniciarJuego() {
            document.getElementById("pantallaSeleccion").style.display = "none";
            canvas.style.display = "block";
            document.getElementById("barraEnergia1").style.display = "block";
            document.getElementById("barraEnergia2").style.display = "block";

            cargarPanelesCartas();

            // Eliminar setInterval para energ√≠a: se actualizar√° en loop

            // Evento √∫nico para invocar unidades seg√∫n mitad y selecci√≥n
            canvas.addEventListener("click", e => {
                const mitad = window.innerWidth / 2;
                const x = e.clientX;
                const y = e.clientY;

                if (x < mitad && seleccionada1) invocarUnidad(1, x, y, seleccionada1);
                else if (x >= mitad && seleccionada2) invocarUnidad(2, x, y, seleccionada2);
            });

            requestAnimationFrame(loop);
        }


        function cargarPanelesCartas() {
            const panel1 = document.getElementById("panel1");
            const panel2 = document.getElementById("panel2");
            panel1.innerHTML = "";
            panel2.innerHTML = "";

            mazo1.forEach(p => {
                const div = document.createElement("div");
                div.className = "carta";
                div.dataset.personajeNombre = p.nombre;

                const escala = 0.5;
                const canvasCarta = document.createElement("canvas");
                const ctxCarta = canvasCarta.getContext("2d");
                canvasCarta.width = p.frameWidth * escala;
                canvasCarta.height = p.frameHeight * escala;
                div.appendChild(canvasCarta);

                const img = new Image();
                img.src = p.idleSrc;

                let frameActual = 0;
                const totalFrames = p.idleFrames;
                const frameWidth = p.frameWidth;
                const frameHeight = p.frameHeight;
                let lastTime = performance.now();
                const frameDuration = 100;

                function animar() {
                    const now = performance.now();
                    if (now - lastTime > frameDuration) {
                        frameActual = (frameActual + 1) % totalFrames;
                        lastTime = now;
                    }
                    ctxCarta.clearRect(0, 0, canvasCarta.width, canvasCarta.height);
                    ctxCarta.drawImage(
                        img,
                        frameActual * frameWidth, 0, frameWidth, frameHeight,
                        0, 0, frameWidth * escala, frameHeight * escala
                    );
                    requestAnimationFrame(animar);
                }

                img.onload = () => {
                    animar();
                };

                div.onclick = () => {
                    if (seleccionada1 === p) seleccionada1 = null;
                    else seleccionada1 = p;
                    actualizarVisualSeleccionPanel(1);
                };

                panel1.appendChild(div);
            });

            mazo2.forEach(p => {
                const div = document.createElement("div");
                div.className = "carta";
                div.dataset.personajeNombre = p.nombre;

                const escala = 0.5;
                const canvasCarta = document.createElement("canvas");
                const ctxCarta = canvasCarta.getContext("2d");
                canvasCarta.width = p.frameWidth * escala;
                canvasCarta.height = p.frameHeight * escala;
                canvasCarta.style.transform = "scaleX(-1)";
                div.appendChild(canvasCarta);

                const img = new Image();
                img.src = p.idleSrc;

                let frameActual = 0;
                const totalFrames = p.idleFrames;
                const frameWidth = p.frameWidth;
                const frameHeight = p.frameHeight;
                let lastTime = performance.now();
                const frameDuration = 100;

                function animar() {
                    const now = performance.now();
                    if (now - lastTime > frameDuration) {
                        frameActual = (frameActual + 1) % totalFrames;
                        lastTime = now;
                    }
                    ctxCarta.clearRect(0, 0, canvasCarta.width, canvasCarta.height);
                    ctxCarta.drawImage(
                        img,
                        frameActual * frameWidth, 0, frameWidth, frameHeight,
                        0, 0, frameWidth * escala, frameHeight * escala
                    );
                    requestAnimationFrame(animar);
                }

                img.onload = () => {
                    animar();
                };

                div.onclick = () => {
                    if (seleccionada2 === p) seleccionada2 = null;
                    else seleccionada2 = p;
                    actualizarVisualSeleccionPanel(2);
                };

                panel2.appendChild(div);
            });
        }


        // Actualiza la visualizaci√≥n para mostrar qu√© carta est√° seleccionada en el panel
        function actualizarVisualSeleccionPanel(jugador) {
            const panel = jugador === 1 ? document.getElementById("panel1") : document.getElementById("panel2");
            const seleccionada = jugador === 1 ? seleccionada1 : seleccionada2;
            const energiaActual = jugador === 1 ? energia1 : energia2;

            let cambio = false;

            Array.from(panel.children).forEach(div => {
                const antes = div.classList.contains("seleccionada");
                if (seleccionada && div.dataset.personajeNombre === seleccionada.nombre) {
                    div.classList.add("seleccionada");
                    if (!antes) cambio = true;
                } else {
                    div.classList.remove("seleccionada");
                    if (antes) cambio = true;
                }
            });

            if (cambio) {
                if (seleccionada) {
                    mostrarPreviewEnergia(jugador, seleccionada.costo, energiaActual, energiaMax);
                } else {
                    ocultarPreviewEnergia(jugador);
                }
            }
        }


        // Invocaci√≥n de unidades respetando energ√≠a y lado
        function invocarUnidad(jugador, x, y, personaje) {
            if (jugador === 1 && energia1 >= personaje.costo) {
                energia1 -= personaje.costo;
                unidades.push({
                    jugador: 1,
                    x,
                    y,
                    hp: personaje.hpMax,
                    damage: personaje.damage,
                    peso: personaje.peso,
                    speed: Math.abs(personaje.speed),
                    personaje: personaje,
                    animFrame: 0,
                    animTime: 0,
                    animSpeed: 100,
                    animType: "idle",
                    img: new Image()
                });
                unidades[unidades.length - 1].img.src = personaje.idleSrc;
                document.getElementById("energia1").style.width = (energia1 / energiaMax * 100) + "%";
            } else if (jugador === 2 && energia2 >= personaje.costo) {
                energia2 -= personaje.costo;
                unidades.push({
                    jugador: 2,
                    x,
                    y,
                    hp: personaje.hpMax,
                    damage: personaje.damage,
                    peso: personaje.peso,
                    speed: -Math.abs(personaje.speed),
                    personaje: personaje,
                    animFrame: 0,
                    animTime: 0,
                    animSpeed: 100,
                    animType: "idle",
                    img: new Image()
                });
                unidades[unidades.length - 1].img.src = personaje.idleSrc;
                document.getElementById("energia2").style.width = (energia2 / energiaMax * 100) + "%";
            }
        }

        function mostrarPreviewEnergia(jugador, costoUnidad, energiaActual, energiaMax) {
            const preview = document.getElementById(`previewEnergia${jugador}`);
            let previewWidth = 0;

            // Si ya est√° en m√°ximo, el preview debe reflejar el costo total
            if (energiaActual >= energiaMax) {
                previewWidth = (costoUnidad / energiaMax) * 100;
            }
            // Si al sumar el costo no supera el m√°ximo, muestra el costo real
            else if (energiaActual + costoUnidad <= energiaMax) {
                previewWidth = (costoUnidad / energiaMax) * 100;
            }
            // Si el costo supera el m√°ximo, muestra el espacio restante como preview
            else {
                previewWidth = ((energiaMax - energiaActual) / energiaMax) * 100;
            }

            preview.style.width = previewWidth + "%";
        }

        function ocultarPreviewEnergia(jugador) {
            const preview = document.getElementById(`previewEnergia${jugador}`);
            preview.style.width = "0%";
        }


        const fortaleza1 = {
            x: 150, // Ajusta seg√∫n ancho de panel1
            y: canvas.height / 2,
            width: 50,
            height: 200,
            hp: 4200,
            maxHp: 4200
        };

        const fortaleza2 = {
            x: canvas.width - 150, // Ajusta seg√∫n ancho de panel2
            y: canvas.height / 2,
            width: 50,
            height: 200,
            hp: 4200,
            maxHp: 4200
        };

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            fortaleza1.y = canvas.height / 2;
            fortaleza2.x = canvas.width - 150;
            fortaleza2.y = canvas.height / 2;
        });
        function dibujarFortaleza(f) {
            ctx.fillStyle = "gray";
            ctx.fillRect(
                f.x - f.width / 2,
                f.y - f.height / 2,
                f.width,
                f.height
            );

            // Barra de vida
            const vidaPercent = f.hp / f.maxHp;
            ctx.fillStyle = "red";
            ctx.fillRect(f.x - 25, f.y - f.height / 2 - 20, 50, 5);
            ctx.fillStyle = "green";
            ctx.fillRect(f.x - 25, f.y - f.height / 2 - 20, 50 * vidaPercent, 5);
            ctx.strokeStyle = "black";
            ctx.strokeRect(f.x - 25, f.y - f.height / 2 - 20, 50, 5);
        }



        function loop(timestamp = 0) {
            const delta = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // L√≠nea divisoria central
            ctx.fillStyle = "black";
            ctx.fillRect(canvas.width / 2 - 1, 0, 2, canvas.height);

            // Actualizar energ√≠as suavemente
            if (energia1 < energiaMax) {
                energia1 += energiaPorSegundo * (delta / 1000);
                if (energia1 > energiaMax) energia1 = energiaMax;
                document.getElementById("energia1").style.width = (energia1 / energiaMax * 100) + "%";
            }

            if (energia2 < energiaMax) {
                energia2 += energiaPorSegundo * (delta / 1000);
                if (energia2 > energiaMax) energia2 = energiaMax;
                document.getElementById("energia2").style.width = (energia2 / energiaMax * 100) + "%";
            }

            dibujarFortaleza(fortaleza1);
            dibujarFortaleza(fortaleza2);

            unidades.forEach(u => {
                if (u.alpha === undefined) u.alpha = 1;

                // Inicializar u.img si no existe
                if (!u.img) {
                    u.img = new Image();
                    u.img.src = u.personaje.idleSrc;
                    u.img.onerror = () => {
                        console.error("‚ùå Error cargando imagen:", u.img.src);
                    };
                }

                if (u.hp > 0 && u.estado !== "morir") {
                    let enemigos = unidades.filter(e => e.jugador !== u.jugador && e.hp > 0);
                    let objetivo = enemigos.find(e => Math.abs(e.x - u.x) < 50 && Math.abs(e.y - u.y) < 50);

                    if (!objetivo) {
                        // Si no hay enemigos cerca, ataca la fortaleza enemiga si est√° cerca
                        const f = u.jugador === 1 ? fortaleza2 : fortaleza1;
                        if (Math.abs(u.x - f.x) < 50) {
                            objetivo = f;
                        }
                    }

                    if (objetivo) {
                        u.estado = "atacar";
                        u.objetivoActual = objetivo;
                    } else {
                        if (Math.abs(u.speed) < 0.1) {
                            u.estado = "idle";
                        } else {
                            u.estado = "caminar";
                            u.objetivoActual = null;
                        }
                    }
                } else if (u.hp <= 0 && u.estado !== "morir") {
                    u.estado = "morir";
                    u.animType = "death";
                    u.animFrame = 0;
                    u.animTime = 0;
                    u.img.src = u.personaje.deathSrc;
                }

                // Cambiar animType seg√∫n estado
                let newAnimType = u.animType;
                if (u.estado === "caminar") {
                    newAnimType = Math.abs(u.speed) > 2.5 ? "run" : "walk";
                } else if (u.estado === "atacar") {
                    newAnimType = "attack1";
                } else if (u.estado === "morir") {
                    newAnimType = "death";
                }

                if (u.animType !== newAnimType) {
                    u.animType = newAnimType;
                    u.animFrame = 0;
                    u.animTime = 0;
                    switch (newAnimType) {
                        case "idle": u.img.src = u.personaje.idleSrc; break;
                        case "walk": u.img.src = u.personaje.walkSrc; break;
                        case "run": u.img.src = u.personaje.runSrc; break;
                        case "attack1": u.img.src = u.personaje.attack1Src; break;
                        case "death": u.img.src = u.personaje.deathSrc; break;
                    }
                }

                u.animTime += delta;

                if (u.animTime >= u.animSpeed) {
                    u.animFrame++;
                    u.animTime = 0;

                    const maxFrames = {
                        idle: u.personaje.idleFrames,
                        walk: u.personaje.walkFrames,
                        run: u.personaje.runFrames,
                        attack1: u.personaje.attack1Frames,
                        death: u.personaje.deathFrames
                    }[u.animType];

                    if (u.animFrame >= maxFrames) {
                        if (u.estado === "morir") {
                            u.animFrame = maxFrames - 1; // Mantiene √∫ltimo frame de muerte
                        } else {
                            // üó°Ô∏è Aplica da√±o al finalizar la animaci√≥n de ataque
                            if (u.estado === "atacar" && u.objetivoActual && u.objetivoActual.hp !== undefined) {
                                u.objetivoActual.hp -= u.damage;

                                // Si destruye la fortaleza enemiga
                                if (u.objetivoActual.maxHp && u.objetivoActual.hp <= 0) {
                                    gameOver(u.jugador);
                                }
                            }
                            u.animFrame = 0; // Reinicia animaci√≥n para siguiente ataque o ciclo
                        }
                    }
                }

                // Dibujar personaje
                if (u.img.complete) {
                    const sx = u.animFrame * u.personaje.frameWidth;
                    const sy = 0;
                    const sw = u.personaje.frameWidth;
                    const sh = u.personaje.frameHeight;
                    const dw = sw * escalaPersonaje;
                    const dh = sh * escalaPersonaje;
                    const dx = u.x - dw / 2;
                    const dy = u.y - dh / 2;

                    ctx.save();
                    ctx.globalAlpha = u.alpha;

                    if (u.jugador === 2) {
                        ctx.translate(dx + dw / 2, dy + dh / 2);
                        ctx.scale(-1, 1);
                        ctx.translate(-(dx + dw / 2), -(dy + dh / 2));
                    }

                    ctx.drawImage(u.img, sx, sy, sw, sh, dx, dy, dw, dh);
                    ctx.restore();

                    // Barra de vida
                    if (u.hp > 0) {
                        const vidaPercent = u.hp / u.personaje.hpMax;
                        ctx.fillStyle = "red";
                        ctx.fillRect(u.x - 20, u.y - sh / 2 - 10, 40, 5);
                        ctx.fillStyle = "green";
                        ctx.fillRect(u.x - 20, u.y - sh / 2 - 10, 40 * vidaPercent, 5);
                        ctx.strokeStyle = "black";
                        ctx.strokeRect(u.x - 20, u.y - sh / 2 - 10, 40, 5);
                    }
                }

                if (u.estado === "caminar") {
                    u.x += u.speed;
                }

                if (u.estado === "morir") {
                    u.alpha -= 0.5 * (delta / 1000);
                }
            });

            unidades = unidades.filter(u => u.alpha > 0);

            requestAnimationFrame(loop);
        }

        function gameOver(ganador) {
            const mensaje = document.createElement("div");
            mensaje.className = "pantallaGameOver";
            mensaje.innerHTML = `
      <h1>¬°Jugador ${ganador} gana!</h1>
      <button onclick="location.reload()">Reiniciar</button>
    `;
            document.body.appendChild(mensaje);
        }


    </script>


</body>

</html>